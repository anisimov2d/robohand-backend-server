# triad_serv

–ö–∞–∂–¥–∞—è –∏–∑ –ø–∞–ø–æ–∫ - –æ—Ç–¥–µ–ª—å–Ω—ã–π Flask-—Å–µ—Ä–≤–µ—Ä —Å–æ —Å–≤–æ–∏–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º. –¢–∞–∫ —è —Å–µ–±–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã. –í—Å—ë –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ —Å—Ö–µ–º–µ "–∏–∑–¥–∞—Ç–µ–ª—å-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫-–ø–æ–¥–ø–∏—Å—á–∏–∫", –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º MQTT.

![png](https://raw.githubusercontent.com/anisimovdd/triad_serv/master/triad_serv.png)


üê≥ P.S.: –ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è README.md –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã, —Ç–æ –Ω–µ —Å—Ç–æ–∏—Ç –±–æ—è—Ç—å—Å—è –∑–∞–≥–ª—è–Ω—É—Ç—å –≤ –∫–æ–¥ ‚Äì –æ–Ω —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏. –¢–µ–º –±–æ–ª–µ–µ —Å—Ç–æ–∏—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å —Å 02.10.21.

# preProcessing_serv ( x.x.x.x : 5002 )

1.	–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Mosquitto –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ MQTT_TOPIC = "glove":

		def on_connect(client, userdata, flags, rc):
		if rc == 0:
			print("üü¢ Connected to Mosquitto (" + MQTT_BROKER + ":" + str(MQTT_PORT) + ")")
			client.subscribe(MQTT_TOPIC)
			print("Waiting for any messages with TOPIC='" + MQTT_TOPIC + "'...")
		else:
			print("üî¥ Connection failed")

2.	–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç –ø–µ—Ä—á–∞—Ç–∫–∏ –¥–∞–Ω–Ω—ã–µ –≤ –º–∞—Å—Å–∏–≤:
		
		message = str(msg.payload, 'utf-8')
		print("> TOPIC: " + msg.topic + "\n" + "üì© MESSAGE: " + message)		
		message_arr = message.split(',')
		
		# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –º–∞—Å—Å–∏–≤ –±—É–¥–µ—Ç –∏–º–µ—Ç—å —Å–ª–µ–¥—É—é—â—é—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
		# message_arr = [ R1, R2, R3, R4, R5, AG1, AG2, AG3, IO_button], –≥–¥–µ
		# Rn - –ø–æ–∫–∞–∑–∞–Ω–∏—è —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤ –∏–∑–≥–∏–±–∞ –∫–∞–∂–¥–æ–≥–æ –ø–∞–ª—å—Ü–∞
		# AGn - –ø–æ–∫–∞–∑–∞–Ω–∏—è –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞ –∏ –≥–∏—Ä–æ—Å–∫–æ–ø–∞ 
		# IO_button - –∫–Ω–æ–ø–∫–∞ 0 –∏–ª–∏ 1. –ù–∞ –Ω–µ—ë –≤–æ–∑–ª–æ–∂–µ–Ω–∞ –±–æ–ª—å—à–∞—è –∑–∞–¥–∞—á–∞. –î–∞–Ω–Ω—ã–µ c IO_button = 0,
		# –Ω–∞–ø—Ä—è–º—É—é —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Ä–æ–±–æ—Ä—É–∫—É. –ü—Ä–∏ IO_button = 1 –∞–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è.
		# –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ arr = [ [], [], ... ]. –ü—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –ø–∞–∫–µ—Ç–∞ —Å IO_button = 0,
		# –∑–∞–ø–∏—Å—å –≤ –º–∞—Å—Å–∏–≤ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è –∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è, —á—Ç–æ –æ–Ω –≥–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏
		# –µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ dS_serv.

3.	–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–∏ IO_button –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ–±—É—á–µ–Ω–∏—è –∏ –ø—Ä—è–º–æ–π —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏. –†–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ arr, –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ dataStore_serv:
		
		# –ï—Å–ª–∏ –ø–æ—Å—Ç—É–ø–∏–ª –º–∞—Å—Å–∏–≤ —Å IO_button = 0
		if message_arr[8] == 0:
			# E—Å–ª–∏ –µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ –µ—â—ë –Ω–µ –∑–∞–ø–æ–ª–Ω—è–ª—Å—è –∏–ª–∏ –±—ã–ª –æ—á–∏—â–µ–Ω
			if len(arr) == 0:
				publish.single("dS_serv", payload = msg.payload, hostname = "127.0.0.1", port = 1883)
			# –ï—Å–ª–∏ –µ–¥–∏–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω
			else:
				# –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ–¥–∏–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ —á–µ—Ä–µ–∑ –∞–ª–≥–æ—Ä–∏—Ç–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
				# proc_arr_1 = smoothAlg(arr)
				
				# –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø–µ—Ä—á–∞—Ç–∫–∏. –ü–æ—ç—Ç–æ–º—É –∫–æ–¥ –≤—ã—à–µ –±—ã–ª
				# –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω. –í –¥–∞–ª—å–Ω–µ–π—à–µ–º, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—É–¥–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
				
				# –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –Ω–∞ dS_serv
				publish.single("pP_serv", payload = arr, hostname = "127.0.0.1", port = 1883)
				print("üìß SEND: " + arr)
				# –û—á–∏—Å—Ç–∫–∞ –µ–¥–∏–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
				arr.clear()

		# –ï—Å–ª–∏ –ø–æ—Å—Ç—É–ø–∏–ª –º–∞—Å—Å–∏–≤ —Å IO_button = 1
		else:
			# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
			arr.append(message_arr)
		
# dataStore_serv ( x.x.x.x : 5000 )

1.	–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Mosquitto –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ MQTT_TOPIC = [("pP_serv", 0), ("eH_serv", 0)]:

		def on_connect(client, userdata, flags, rc):
		if rc == 0:
			print("üü¢ Connected to Mosquitto (" + MQTT_BROKER + ":" + str(MQTT_PORT) + ")")
			client.subscribe(MQTT_TOPIC)
			print("Waiting for any messages with TOPIC='" + MQTT_TOPIC[0][0] + "','" + MQTT_TOPIC[1][0] + "'...")
		else:
			print("üî¥ Connection failed")
			
2.	–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç preProcessing_serv –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –∫ –æ–±—â–µ–º—É –º–∞—Å—Å–∏–≤—É arr:
		
		if msg.topic == "pP_serv":
			# –î–æ–±–∞–≤–∏—Ç—å –≤ –æ–±—â–∏–π –º–∞—Å—Å–∏–≤
			arr.append(msg.payload)

3.	–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç eventHandling_serv –∏–∑–≤–ª–µ–∫–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –º–∞—Å—Å–∏–≤ –∏–∑ –æ–±—â–µ–≥–æ –º–∞—Å—Å–∏–≤–∞. –ü–æ–æ—á–µ—Ä—ë–¥–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Å—Å–∏–≤–∞ –Ω–∞ —Ä–æ–±–æ—Ä—É–∫—É:

		else:
			# –°–æ–±—ã—Ç–∏–µ 1 -- –ø–æ–∂–∞—Ç—å —Ä—É–∫—É
			if msg.payload == "event_1":
				event_1_arr = arr[0]
				# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –∑–∞–ø—è—Ç–æ–π –∏ –ø–µ—Ä–µ–¥–∞—ë–º –Ω–∞ —Ä–æ–±–æ—Ä—É–∫—É
				for e in event_1_arr:
					e_str = ','.join(map(str, e))
					publish.single("dS_serv", payload = e_str, hostname = "127.0.0.1", port = 1883)
					print("üìß SEND: " + e_str)
			
			# –°–æ–±—ã—Ç–∏–µ 2 -- –≤–∑—è—Ç—å –ø—Ä–µ–¥–º–µ—Ç
			elif msg.payload == "event_2":
				event_2_arr = arr[1]
				# ... —Ç–æ—Ç –∂–µ –∫–æ–¥
			
			# –°–æ–±—ã—Ç–∏–µ 3 -- –ø–æ–∫–∞–∑–∞—Ç—å –∂–µ—Å—Ç
			elif msg.payload == "event_3":
				event_3_arr = arr[2]
				# ... —Ç–æ—Ç –∂–µ –∫–æ–¥
			
			# –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
			else:
				print("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ")

# eventHandling_serv ( x.x.x.x : 5001)

1.	–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Mosquitto –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ MQTT_TOPIC = "robohand":

		def on_connect(client, userdata, flags, rc):
		if rc == 0:
			print("üü¢ Connected to Mosquitto (" + MQTT_BROKER + ":" + str(MQTT_PORT) + ")")
			client.subscribe(MQTT_TOPIC)
			print("Waiting for any messages with TOPIC='" + MQTT_TOPIC + "'...")
		else:
			print("üî¥ Connection failed")

2.	–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç –¥–∞—Ç—á–∏–∫–æ–≤ —Ä–æ–±–æ—Ä—É–∫–∏ –¥–∞–Ω–Ω—ã–µ –≤ –º–∞—Å—Å–∏–≤:
	
		message = str(msg.payload, 'utf-8')
		print("> TOPIC: " + msg.topic + "\n" + "üì© MESSAGE: " + message)
		message_arr = message.split(',')
		
		# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –º–∞—Å—Å–∏–≤ –±—É–¥–µ—Ç –∏–º–µ—Ç—å —Å–ª–µ–¥—É—é—â—é—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
		# message_arr = [ T1, T2, T3, T4, T5, S1, S2, S3, S4, S5 ], –≥–¥–µ
		# Tn - –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
		# Sn - –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤ –¥–∞–≤–ª–µ–Ω–∏—è
		
3.	–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π. –í —Å–ª—É—á–∞–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—è –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ dataStore_serv:
		
		# –°–æ–±—ã—Ç–∏–µ 1 -- –ø–æ–∂–∞—Ç—å —Ä—É–∫—É
		if (29 < message_arr[0] < 45):
			publish.single("eH_serv", payload = "event_1", hostname = "127.0.0.1", port = 1883)
			# –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –≤ –ø—Ä–∏—ë–º–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è

		# –°–æ–±—ã—Ç–∏–µ 2 -- –≤–∑—è—Ç—å –ø—Ä–µ–¥–º–µ—Ç
		elif (145 < message_arr[5] < 654):
			publish.single("eH_serv", payload = "event_2", hostname = "127.0.0.1", port = 1883)
			# –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –≤ –ø—Ä–∏—ë–º–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
		
		# –°–æ–±—ã—Ç–∏–µ 3 -- –ø–æ–∫–∞–∑–∞—Ç—å –∂–µ—Å—Ç
		elif (800 < message_arr[0] < 1455):
			publish.single("eH_serv", payload = "event_3", hostname = "127.0.0.1", port = 1883)
			# –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –≤ –ø—Ä–∏—ë–º–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
		
		# –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
		else:
			print("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ")
